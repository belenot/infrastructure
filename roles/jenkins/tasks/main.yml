---
- name: Set environment variable for Jenkins Public Url.
  lineinfile:
    path: /etc/environment
    line: JENKINS_PUBLIC_URL={{ jenkins_public_url }}
  become: yes

- name: Create home directory for Jenkins.
  user:
    name: jenkins
    #move_home: yes
    create_home: yes
    home: /home/jenkins
  become: yes

- name: Create ~/.ssh directory.
  file:
    path: ~/.ssh
    state: directory
    mode: '700'
  become: yes
  become_user: jenkins

- name: Install git private key.
  copy:
    src: git_private_key
    dest: ~/.ssh/id_rsa
    mode: '600'
  become: yes
  become_user: jenkins

- name: Add github public key to ~/.ssh/known_hosts.
  lineinfile:
    path: ~/.ssh/known_hosts
    line: '{{ item }}'
    create: yes
  become: yes
  become_user: jenkins
  loop: '{{ known_hosts }}'

- name: Add Jenkins repository key.
  apt_key:
    url: '{{ jenkins_key_url }}'
    state: present
  become: yes

- name: Add Jenkins repository.
  apt_repository:
    repo: deb https://pkg.jenkins.io/debian-stable binary/
    state: present
    filename: jenkins
  become: yes

- name: Update apt cache.
  apt:
    update_cache: yes
  become: yes

- name: Install JDK.
  apt:
    name: openjdk-8-jdk
  become: yes

- name: Install Jenkins.
  apt:
    name: jenkins
  become: yes
  environment:
    JAVA_ARGS: -Djenkins.install.runSetupWizard=false
  notify: restart jenkins

- name: Create /var/lib/jenkins/init.groovy.d directory.
  file:
    path: /var/lib/jenkins/init.groovy.d
    state: directory
  become: yes
  become_user: jenkins

- name: Enable jenkins service.
  service:
    name: jenkins
    enabled: yes
    state: started
  become: yes

- name: Wait for Jenkins started.
  wait_for:
    search_regex: Jenkins is fully up and running
    delay: 10
    sleep: 5
    path: /var/log/jenkins/jenkins.log

- name: Copy 01-init-jenkins-plugins.groovy to /var/lib/jenkins/init.groovy.d/.
  copy:
    src: 01-init-jenkins-plugins.groovy
    dest: /var/lib/jenkins/init.groovy.d/01-init-jenkins-plugins.groovy
  become: yes
  become_user: jenkins
  notify: restart jenkins

- name: Copy 02-init-jenkins.groovy to /var/lib/jenkins/init.groovy.d/.
  copy:
    src: 02-init-jenkins.groovy
    dest: /var/lib/jenkins/init.groovy.d/02-init-jenkins.groovy
  become: yes
  become_user: jenkins
  notify: restart jenkins